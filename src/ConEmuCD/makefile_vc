
.SILENT:

NAME=ConEmuCD
EXT=dll
X64SUFF=64
RELEASEDIR=..\..\Release\ConEmu
NEEDENTRY = 1
NO_OPTIMIZE = 1
USE_PDB = 1
DEF_FILE = export.def

#Issue 1876
NEEDDEFLIB = 1
!undef USEDDKCRT

!include ../makefile_vc_defs

ALL: dirs build release

USERLIBS = kernel32.lib user32.lib gdi32.lib advapi32.lib shell32.lib shlwapi.lib oleaut32.lib


# !!! WindowsXP для ConsoleAlias !!!
CPPWINVER=/D_WIN32_WINNT=0x0501

BASEADDRESS=/DYNAMICBASE:NO /BASE:0x54610000 /FIXED:NO
#/BASE:0x6F780000 



!ifndef DEBUG
CPP_OPT=$(CPP_OPT) /DNDEBUG /Fd$(PDBNAME) /DHIDE_TODO
#/DCRTSTARTUP
!else
CPP_OPT=$(CPP_OPT) /DDEBUG /Zi /Fd$(PDBNAME)
#/DCRTSTARTUP
!endif

#COMMONLIB =

!ifdef AMD64
CPP_PROJ_NO=/nologo /c /W3 /wd4995 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS $(USERCPP)
ULOUT=-Tpd+
LINK_MACHINE = /MACHINE:X64
!elseif defined(IA64)
CPP_PROJ_NO=/nologo /c /W3 /wd4995 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS $(USERCPP)
ULOUT=-Tpd+
LINK_MACHINE = /MACHINE:X64
!else
!ifdef CPP_UNALIGN
CPP_ALIGN=/Zp1
!endif
CPP_PROJ_NO=/nologo /c /W3 /wd4995 /Gy /GF $(CPP_ALIGN) /J /Gr /GS- /GR- /EHs-c- /LD $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS $(CPPWINVER) $(USERCPP)
ULOUT=-Tpd -Re
LINK_MACHINE = /MACHINE:X86
!endif
CPP_PROJ=$(CPP_PROJ_NO) /Fo"$(INTDIR)\\"

LIBS = $(CRTLIB) $(USERLIBS)



!ifndef DEBUG
LINK_DEBUG=/map:"$(MAP)" /debug /pdb:$(PDBNAME)
CPP_DEBUG=/Zi
!else
LINK_DEBUG=/map:"$(MAP)" /debug /pdb:$(PDBNAME)
CPP_DEBUG=/Zi
!endif


#/merge:.rdata=.text /SUBSYSTEM:WINDOWS
#/ENTRY:_DllMainCRTStartup
LINK_FLAGS=/nologo /DLL /RELEASE $(BASEADDRESS) $(LINK_MACHINE) $(NOWIN98) $(ENV_LIB_OPT) /def:"$(DEF_FILE)" /out:"$(OUTFULLNAME)" $(LINK_DEBUG)


CPPFLAGS = $(MP) $(CPP_PROJ) $(CPP_DEBUG) $(CPP_OPT)



!include ../makefile_vc_link


.PHONY: build
build: "$(OUTFULLNAME)"


$(RES): $(RC_NAME).rc
	@$(RC) $(ENV_INC_OPT) $(RC_WIDE) /fo"$(RES)" $(RC_NAME).rc




################

LINK_OBJS = \
$(INTDIR)\Actions.obj \
$(INTDIR)\CEStr.obj \
$(INTDIR)\CmdLine.obj \
$(INTDIR)\Common.obj \
$(INTDIR)\ConEmuCheck.obj \
$(INTDIR)\ConEmuCmd.obj \
$(INTDIR)\ConEmuSrv.obj \
$(INTDIR)\ConProcess.obj \
$(INTDIR)\ConsoleMain.obj \
$(INTDIR)\ConsoleMixAttr.obj \
$(INTDIR)\ConsoleRead.obj \
$(INTDIR)\Debugger.obj \
$(INTDIR)\DownloaderCall.obj \
$(INTDIR)\EmergencyShow.obj \
$(INTDIR)\ExecPty.obj \
$(INTDIR)\execute.obj \
$(INTDIR)\GuiHooks.obj \
$(INTDIR)\GuiMacro.obj \
$(INTDIR)\HkFunc.obj \
$(INTDIR)\Infiltrate.obj \
$(INTDIR)\InjectRemote.obj \
$(INTDIR)\Injects.obj \
$(INTDIR)\InQueue.obj \
$(INTDIR)\MapDump.obj \
$(INTDIR)\MAssert.obj \
$(INTDIR)\MConHandle.obj \
$(INTDIR)\Memory.obj \
$(INTDIR)\MFileLog.obj \
$(INTDIR)\MModule.obj \
$(INTDIR)\Monitors.obj \
$(INTDIR)\MPerfCounter.obj \
$(INTDIR)\MProcess.obj \
$(INTDIR)\MProcessBits.obj \
$(INTDIR)\MRect.obj \
$(INTDIR)\MSection.obj \
$(INTDIR)\MSectionSimple.obj \
$(INTDIR)\MSecurity.obj \
$(INTDIR)\MStrDup.obj \
$(INTDIR)\MStrSafe.obj \
$(INTDIR)\ProcessSetEnv.obj \
$(INTDIR)\Queue.obj \
$(INTDIR)\RConStartArgs.obj \
$(INTDIR)\SetEnvVar.obj \
$(INTDIR)\SrvCommands.obj \
$(INTDIR)\SrvPipes.obj \
$(INTDIR)\StartEnv.obj \
$(INTDIR)\UnicodeTest.obj \
$(INTDIR)\WCodePage.obj \
$(INTDIR)\WConsole.obj \
$(INTDIR)\WConsoleInfo.obj \
$(INTDIR)\WFiles.obj \
$(INTDIR)\WModuleCheck.obj \
$(INTDIR)\WObjects.obj \
$(INTDIR)\WSession.obj \
$(INTDIR)\WThreads.obj \
$(INTDIR)\WUser.obj


################
#LINK_OBJS begin

$(INTDIR)\Actions.obj: Actions.cpp Actions.h

$(INTDIR)\CEStr.obj: ../common/CEStr.cpp ../common/CEStr.h

$(INTDIR)\CmdLine.obj: ../common/CmdLine.cpp ../common/CmdLine.h

$(INTDIR)\Common.obj: ../common/Common.cpp

$(INTDIR)\ConEmuCheck.obj: ../common/ConEmuCheck.cpp ../common/ConEmuCheck.h

$(INTDIR)\ConEmuCmd.obj: ConEmuCmd.cpp ../common/PipeServer.h

$(INTDIR)\ConEmuSrv.obj: ConEmuSrv.cpp ../common/PipeServer.h

$(INTDIR)\ConProcess.obj: ConProcess.cpp

$(INTDIR)\ConsoleMain.obj: ConsoleMain.cpp ../common/PipeServer.h

$(INTDIR)\ConsoleMixAttr.obj: ../common/ConsoleMixAttr.cpp ../common/ConsoleMixAttr.h

$(INTDIR)\ConsoleRead.obj: ../common/ConsoleRead.cpp ../common/ConsoleRead.h

$(INTDIR)\Debugger.obj: Debugger.cpp Debugger.h

$(INTDIR)\DownloaderCall.obj: DownloaderCall.cpp DownloaderCall.h ../ConEmuC/DownloaderApi.h

$(INTDIR)\EmergencyShow.obj: ../common/EmergencyShow.cpp ../common/EmergencyShow.h

$(INTDIR)\ExecPty.obj: ../common/ExecPty.cpp ../common/ExecPty.h

$(INTDIR)\execute.obj: ../common/execute.cpp ../common/execute.h

$(INTDIR)\GuiHooks.obj: GuiHooks.cpp GuiHooks.h

$(INTDIR)\GuiMacro.obj: GuiMacro.cpp GuiMacro.h

$(INTDIR)\HkFunc.obj: ../common/HkFunc.cpp ../common/HkFunc.h

$(INTDIR)\Infiltrate.obj: Infiltrate.cpp

$(INTDIR)\InjectRemote.obj: InjectRemote.cpp

$(INTDIR)\Injects.obj: ..\ConEmuHk\Injects.cpp

$(INTDIR)\InQueue.obj: ../common/InQueue.cpp ../common/InQueue.h

$(INTDIR)\MapDump.obj: MapDump.cpp MapDump.h

$(INTDIR)\MAssert.obj: ../common/MAssert.cpp

$(INTDIR)\MConHandle.obj: ../common/MConHandle.cpp ../common/MSection.h ../common/MSectionSimple.h ../common/StartupEnv.h ../common/StartupEnvDef.h ../common/MFileLog.h ../common/MConHandle.h

$(INTDIR)\Memory.obj: ../common/Memory.cpp

$(INTDIR)\MFileLog.obj: ../common/MFileLog.cpp ../common/MSection.h ../common/MSectionSimple.h ../common/StartupEnv.h ../common/StartupEnvDef.h ../common/MFileLog.h ../common/MConHandle.h

$(INTDIR)\MModule.obj: ../common/MModule.cpp ../common/MModule.h

$(INTDIR)\Monitors.obj: ../common/Monitors.cpp

$(INTDIR)\MPerfCounter.obj: ../common/MPerfCounter.cpp ../common/MPerfCounter.h

$(INTDIR)\MProcess.obj: ../common/MProcess.cpp ../common/MProcess.h ../common/MToolHelp.h

$(INTDIR)\MProcessBits.obj: ../common/MProcessBits.cpp ../common/MProcessBits.h

$(INTDIR)\MRect.obj: ../common/MRect.cpp ../common/MRect.h

$(INTDIR)\MSection.obj: ../common/MSection.cpp ../common/MSection.h ../common/MSectionSimple.h ../common/StartupEnv.h ../common/StartupEnvDef.h ../common/MFileLog.h ../common/MConHandle.h

$(INTDIR)\MSectionSimple.obj: ../common/MSectionSimple.cpp ../common/MSection.h ../common/MSectionSimple.h ../common/StartupEnv.h ../common/StartupEnvDef.h ../common/MFileLog.h ../common/MConHandle.h

$(INTDIR)\MSecurity.obj: ../common/MSecurity.cpp

$(INTDIR)\MStrDup.obj: ../common/MStrDup.cpp ../common/MStrDup.h

$(INTDIR)\MStrSafe.obj: ../common/MStrSafe.cpp

$(INTDIR)\ProcessSetEnv.obj: ../common/ProcessSetEnv.cpp ../common/ProcessSetEnv.h

$(INTDIR)\Queue.obj: Queue.cpp ../common/PipeServer.h ../common/InQueue.h

$(INTDIR)\RConStartArgs.obj: ../common/RConStartArgs.cpp ../common/RConStartArgs.h

$(INTDIR)\SetEnvVar.obj: ../common/SetEnvVar.cpp

$(INTDIR)\SrvCommands.obj: SrvCommands.cpp SrvCommands.h

$(INTDIR)\SrvPipes.obj: SrvPipes.cpp ../common/PipeServer.h

$(INTDIR)\StartEnv.obj: StartEnv.cpp StartEnv.h

$(INTDIR)\UnicodeTest.obj: UnicodeTest.cpp UnicodeTest.h

$(INTDIR)\WCodePage.obj: ../common/WCodePage.cpp ../common/WCodePage.h

$(INTDIR)\WConsole.obj: ../common/WConsole.cpp ../common/WConsole.h

$(INTDIR)\WConsoleInfo.obj: ../common/WConsoleInfo.cpp ../common/WConsoleInfo.h

$(INTDIR)\WFiles.obj: ../common/WFiles.cpp ../common/WFiles.h

$(INTDIR)\WModuleCheck.obj: ../common/WModuleCheck.cpp ../common/WModuleCheck.h

$(INTDIR)\WObjects.obj: ../common/WObjects.cpp ../common/WObjects.h

$(INTDIR)\WSession.obj: ../common/WSession.cpp ../common/WSession.h

$(INTDIR)\WThreads.obj: ../common/WThreads.cpp ../common/WThreads.h

$(INTDIR)\WUser.obj: ../common/WUser.cpp ../common/WUser.h

#LINK_OBJS end
##############


"$(OUTFULLNAME)": $(LINK_OBJS) $(RES) $(LINK_DEP)
	@echo $(CLR_BRN)linking $@ :: $(LINK_FLAGS) $(LIBS)$(CLR_STD)
	$(LNK) @<<
	$(LINK_FLAGS) $(LIBS) $(LINK_OBJS) $(RES)
<<
